import*as t from"https://unpkg.com/three@0.161.0/build/three.module.js";import{BrowserProvider as V}from"https://esm.sh/ethers@6.13.2";import A,{LocalStorage as O}from"https://esm.sh/@privy-io/js-sdk-core@0.60.1";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function r(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=r(a);fetch(a.href,i)}})();const T=`${location.protocol==="https:"?"wss":"ws"}://${location.host}/agentverse-ws`,M=8453,Y="lilagent.xyz",q="lobby",v=window.__PRIVY_APP_ID__||localStorage.getItem("PRIVY_APP_ID")||"cmlrxgwh802rd0bkztv4iceu2",y=window.__PRIVY_CLIENT_ID__||localStorage.getItem("PRIVY_CLIENT_ID")||"cmhuq6qqv00dfi60b72eee6bn",$=document.getElementById("status"),x=document.getElementById("connect"),B=document.getElementById("agents"),H=document.getElementById("agentCount"),F=document.getElementById("app");function w(e){$.textContent=`Status: ${e}`}const d=new t.Scene;d.background=new t.Color(9025535);d.fog=new t.Fog(9025535,90,340);const c=new t.PerspectiveCamera(76,innerWidth/innerHeight,.1,1200);c.position.set(0,1.7,10);const h=new t.WebGLRenderer({antialias:!0});h.setSize(innerWidth,innerHeight);h.setPixelRatio(Math.min(window.devicePixelRatio,2));h.shadowMap.enabled=!0;F.appendChild(h.domElement);d.add(new t.HemisphereLight(15661055,5991800,1.1));const S=new t.DirectionalLight(16777215,1.15);S.position.set(120,180,70);S.castShadow=!0;d.add(S);const P=new t.Mesh(new t.PlaneGeometry(900,900),new t.MeshStandardMaterial({color:5078850,roughness:.96,metalness:.03}));P.rotation.x=-Math.PI/2;P.receiveShadow=!0;d.add(P);function C(e,o,r,s){const a=new t.Mesh(new t.PlaneGeometry(e,o),new t.MeshStandardMaterial({color:3092276,roughness:.92}));a.rotation.x=-Math.PI/2,a.position.set(r,.02,s),d.add(a)}C(260,14,0,0);C(14,260,0,0);const b=new t.Mesh(new t.CircleGeometry(42,64),new t.MeshStandardMaterial({color:2981119,transparent:!0,opacity:.72,roughness:.2,metalness:.1}));b.rotation.x=-Math.PI/2;b.position.set(-95,.04,85);d.add(b);const L=new t.Group;d.add(L);const X=new t.MeshStandardMaterial({color:7229236,roughness:.98}),K=new t.MeshStandardMaterial({color:2785075,roughness:.9});function Z(e,o,r=1){const s=new t.Mesh(new t.CylinderGeometry(.35*r,.48*r,3.5*r,8),X);s.position.set(e,1.75*r,o),s.castShadow=!0;const a=new t.Mesh(new t.SphereGeometry(2.4*r,12,10),K);a.position.set(e,4.6*r,o),a.castShadow=!0,L.add(s,a)}for(let e=0;e<140;e++){const o=(Math.random()-.5)*560,r=(Math.random()-.5)*560;Math.abs(o)<22||Math.abs(r)<22||Z(o,r,.8+Math.random()*.8)}const N=new t.Group;d.add(N);function J(e,o,r=8,s=7,a=5){const i=new t.Mesh(new t.BoxGeometry(r,a,s),new t.MeshStandardMaterial({color:15196631,roughness:.92}));i.position.set(e,a/2,o),i.castShadow=!0;const n=new t.Mesh(new t.ConeGeometry(Math.max(r,s)*.74,3.2,4),new t.MeshStandardMaterial({color:10040115,roughness:.9}));n.position.set(e,a+1.8,o),n.rotation.y=Math.PI*.25,n.castShadow=!0,N.add(i,n)}const _=[-60,-40,-20,20,40,60];for(const e of _)for(const o of _)Math.abs(e)<25&&Math.abs(o)<25||Math.random()>.45&&J(e*1.8,o*1.8,7+Math.random()*3,6+Math.random()*3,4+Math.random()*2);const z=[];function j(e){const o=new t.Group,r=new t.Mesh(new t.CapsuleGeometry(.3,.8,4,8),new t.MeshStandardMaterial({color:14540253}));r.castShadow=!0;const s=new t.Mesh(new t.SphereGeometry(.24,10,10),new t.MeshStandardMaterial({color:16766640}));s.position.y=.95,o.add(r,s),o.position.set((Math.random()-.5)*140,1.05,(Math.random()-.5)*140),d.add(o),z.push({mesh:o,angle:Math.random()*Math.PI*2,radius:8+Math.random()*32,speed:.12+Math.random()*.22,centerX:o.position.x,centerZ:o.position.z})}for(let e=0;e<28;e++)j();const f=new Map;function Q(e=7268351){const o=new t.Group,r=new t.Mesh(new t.IcosahedronGeometry(.42,1),new t.MeshStandardMaterial({color:e,emissive:1123386,roughness:.35,metalness:.4})),s=new t.Mesh(new t.TorusGeometry(.7,.05,12,40),new t.MeshStandardMaterial({color:12031222,roughness:.45}));return s.rotation.x=Math.PI*.45,o.add(r,s),o}function g(e,o,r,s,a=7268351){let i=f.get(e);if(!i){const n=Q(a);d.add(n);const m=document.createElement("li");m.id=`agent-${e}`,m.textContent=e,B.appendChild(m),f.set(e,{mesh:n,target:new t.Vector3(o,r,s)})}i=f.get(e),i.target.set(o,r,s),U()}function U(){H.textContent=String(f.size)}const k=[];for(let e=1;e<=12;e++){const o=`agent-bot-${String(e).padStart(2,"0")}`;g(o,(Math.random()-.5)*80,2,(Math.random()-.5)*80,2282478),k.push({id:o,angle:Math.random()*Math.PI*2,radius:8+Math.random()*40,speed:.18+Math.random()*.2,centerX:(Math.random()-.5)*80,centerZ:(Math.random()-.5)*80})}const u={};let G=0,p=0,E=!1;addEventListener("keydown",e=>u[e.code]=!0);addEventListener("keyup",e=>u[e.code]=!1);h.domElement.addEventListener("click",()=>{E||h.domElement.requestPointerLock()});document.addEventListener("pointerlockchange",()=>{E=document.pointerLockElement===h.domElement});document.addEventListener("mousemove",e=>{E&&(G-=e.movementX*.0022,p-=e.movementY*.0022,p=Math.max(-1.2,Math.min(1.2,p)))});let l=null,I=null;function ee(e=""){if(!e){w("wallet connected · local mode");return}l=new WebSocket(T),l.onopen=()=>{l.send(JSON.stringify({type:"hello",wsToken:e})),w("wallet connected · websocket connected")},l.onmessage=o=>{try{const r=JSON.parse(o.data);r.type==="presence"&&r.userId&&g(r.userId,Number(r.x??0),Number(r.y??2),Number(r.z??0),8246268)}catch{}},l.onclose=()=>{w("wallet connected · websocket disconnected")},I&&clearInterval(I),I=setInterval(()=>{!l||l.readyState!==WebSocket.OPEN||(l.send(JSON.stringify({type:"heartbeat",ts:Date.now()})),l.send(JSON.stringify({type:"presence",worldId:q,x:Number(c.position.x.toFixed(3)),y:Number(c.position.y.toFixed(3)),z:Number(c.position.z.toFixed(3))})))},2500)}async function te(){if(y.startsWith("REPLACE_"))throw new Error("Privy is not configured. Set window.__PRIVY_CLIENT_ID__ (or localStorage.PRIVY_CLIENT_ID)");if(!window.ethereum)throw new Error("No injected wallet found for Privy SIWE flow");const e=new V(window.ethereum),o=await e.getNetwork();if(Number(o.chainId)!==M){const W=`0x${M.toString(16)}`;await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:W}]})}const r=await e.getSigner(),s=await r.getAddress(),a={clientId:y,storage:new O};v!==y&&(a.appId=v);const i=new A(a);await i.initialize();const n={address:s,chainId:`eip155:${M}`,walletClientType:"metamask",connectorType:"injected"},{message:m}=await i.auth.siwe.init(n,Y,`${location.origin}/agentverse`),R=await r.signMessage(m);return await i.auth.siwe.loginWithSiwe(R,n,m),{address:s,wsToken:""}}x.onclick=async()=>{try{x.disabled=!0,w("connecting wallet via Privy");const e=await te();g("you",c.position.x,2,c.position.z,11032055),ee(e.wsToken||"")}catch(e){console.error("Privy wallet connection failed:",e),w(`Privy error: ${(e==null?void 0:e.message)||"wallet connection error"}`)}finally{x.disabled=!1}};const ne=new t.Clock;function D(){requestAnimationFrame(D);const e=ne.getDelta();c.rotation.order="YXZ",c.rotation.y=G,c.rotation.x=p;const r=7*(u.ShiftLeft?1.9:1),s=new t.Vector3;u.KeyW&&(s.z-=1),u.KeyS&&(s.z+=1),u.KeyA&&(s.x-=1),u.KeyD&&(s.x+=1),s.normalize();const a=new t.Vector3(0,0,-1).applyQuaternion(c.quaternion).setY(0).normalize(),i=new t.Vector3(1,0,0).applyQuaternion(c.quaternion).setY(0).normalize();c.position.addScaledVector(a,s.z*r*e),c.position.addScaledVector(i,s.x*r*e),c.position.y=1.7,c.position.x=Math.max(-320,Math.min(320,c.position.x)),c.position.z=Math.max(-320,Math.min(320,c.position.z));for(const n of z)n.angle+=n.speed*e,n.mesh.position.x=n.centerX+Math.cos(n.angle)*n.radius,n.mesh.position.z=n.centerZ+Math.sin(n.angle)*n.radius,n.mesh.rotation.y=-n.angle;for(const n of k)n.angle+=n.speed*e,g(n.id,n.centerX+Math.cos(n.angle)*n.radius,2+Math.sin(n.angle*2)*.25,n.centerZ+Math.sin(n.angle)*n.radius,2282478);for(const[,n]of f)n.mesh.position.lerp(n.target,.14),n.mesh.rotation.y+=e*.8;h.render(d,c)}D();addEventListener("resize",()=>{c.aspect=innerWidth/innerHeight,c.updateProjectionMatrix(),h.setSize(innerWidth,innerHeight)});
